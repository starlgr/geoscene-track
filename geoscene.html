<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoScene å®æ—¶ä½ç½®è¿½è¸ª</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(135deg, #0079c1 0%, #005e95 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        #mapView {
            flex: 1;
            width: 100%;
        }
        
        .control-panel {
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            border-top: 1px solid #e0e0e0;
        }
        
        .status-container {
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .status-label {
            font-weight: 600;
            color: #555;
        }
        
        .status-value {
            color: #0079c1;
        }
        
        .accuracy-high { color: #4CAF50; }
        .accuracy-medium { color: #FF9800; }
        .accuracy-low { color: #F44336; }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #0079c1;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #005e95;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .icon {
            font-size: 1.2rem;
        }
        
        .tracking-active {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 121, 193, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 121, 193, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 121, 193, 0); }
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            gap: 15px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid rgba(0, 121, 193, 0.1);
            border-radius: 50%;
            border-top: 4px solid #0079c1;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-bubble {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-width: 90%;
            text-align: center;
            border-left: 4px solid #4CAF50;
            display: none;
        }
        
        .error {
            border-left-color: #F44336;
        }
        
        @media (max-width: 480px) {
            header {
                padding: 14px 16px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            .control-panel {
                padding: 12px 16px;
            }
            
            .btn {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><span class="icon">ğŸ“</span> GeoScene å®æ—¶ä½ç½®è¿½è¸ª</h1>
        <div class="subtitle">ç‚¹å‡»å¼€å§‹è¿½è¸ªæŒ‰é’®ï¼Œè·å–æ‚¨çš„å®æ—¶ä½ç½®</div>
    </header>
    
    <div id="mapView"></div>
    
    <div class="control-panel">
        <div class="status-container">
            <div class="status-item">
                <span class="status-label">è¿½è¸ªçŠ¶æ€:</span>
                <span id="trackingStatus" class="status-value">æœªå¼€å§‹</span>
            </div>
            <div class="status-item">
                <span class="status-label">å½“å‰ä½ç½®:</span>
                <span id="currentPosition" class="status-value">ç­‰å¾…å®šä½...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å®šä½ç²¾åº¦:</span>
                <span id="accuracy" class="status-value">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ›´æ–°æ—¶é—´:</span>
                <span id="lastUpdate" class="status-value">--</span>
            </div>
        </div>
        
        <div class="button-group">
            <button id="startTracking" class="btn btn-primary">
                <span class="icon">â–¶ï¸</span> å¼€å§‹è¿½è¸ª
            </button>
            <button id="stopTracking" class="btn btn-secondary" disabled>
                <span class="icon">â¸ï¸</span> åœæ­¢è¿½è¸ª
            </button>
        </div>
    </div>
    
    <div id="infoBubble" class="info-bubble"></div>
    
    <script src="https://js.arcgis.com/4.28/"></script>
    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/Track",
            "esri/Graphic",
            "esri/geometry/Point",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/Color",
            "esri/layers/GraphicsLayer"
        ], function(Map, MapView, Track, Graphic, Point, SimpleMarkerSymbol, 
                   SimpleLineSymbol, SimpleFillSymbol, Color, GraphicsLayer) {
            
            // åˆå§‹åŒ–åœ°å›¾
            const map = new Map({
                basemap: "streets-navigation-vector"
            });
            
            // åˆ›å»ºåœ°å›¾è§†å›¾
            const view = new MapView({
                container: "mapView",
                map: map,
                center: [116.4074, 39.9042], // åŒ—äº¬ä¸­å¿ƒç‚¹ä½œä¸ºåˆå§‹ä½ç½®
                zoom: 12,
                constraints: {
                    minZoom: 3,
                    maxZoom: 20
                }
            });
            
            // åˆ›å»ºå›¾å½¢å›¾å±‚ç”¨äºæ˜¾ç¤ºä½ç½®æ ‡è®°å’Œè½¨è¿¹
            const positionLayer = new GraphicsLayer();
            const trackLayer = new GraphicsLayer();
            map.add(positionLayer);
            map.add(trackLayer);
            
            // åˆ›å»ºä½ç½®æ ‡è®°ç¬¦å·
            const locationSymbol = new SimpleMarkerSymbol({
                color: new Color([0, 121, 193, 0.9]),
                outline: {
                    color: new Color([255, 255, 255, 0.9]),
                    width: 2
                },
                size: 16
            });
            
            // åˆ›å»ºç²¾åº¦èŒƒå›´ç¬¦å·
            const accuracySymbol = new SimpleFillSymbol({
                color: new Color([0, 121, 193, 0.15]),
                outline: new SimpleLineSymbol({
                    color: new Color([0, 121, 193, 0.5]),
                    width: 1,
                    style: "dash"
                })
            });
            
            // åˆ›å»ºè½¨è¿¹çº¿ç¬¦å·
            const trackLineSymbol = new SimpleLineSymbol({
                color: new Color([0, 121, 193, 0.7]),
                width: 3,
                style: "solid"
            });
            
            // åˆå§‹åŒ–è¿½è¸ªç»„ä»¶
            const track = new Track({
                view: view,
                useHeadingEnabled: false, // ä¸å¯ç”¨æ–¹å‘è¿½è¸ª
                goToLocationEnabled: true, // å®šä½æ—¶åœ°å›¾è‡ªåŠ¨è·³è½¬
                graphic: new Graphic({
                    symbol: locationSymbol
                })
            });
            
            // å°†è¿½è¸ªç»„ä»¶æ·»åŠ åˆ°è§†å›¾UIä¸­
            view.ui.add(track, "top-left");
            
            // DOMå…ƒç´ å¼•ç”¨
            const startTrackingBtn = document.getElementById("startTracking");
            const stopTrackingBtn = document.getElementById("stopTracking");
            const trackingStatusEl = document.getElementById("trackingStatus");
            const currentPositionEl = document.getElementById("currentPosition");
            const accuracyEl = document.getElementById("accuracy");
            const lastUpdateEl = document.getElementById("lastUpdate");
            const infoBubble = document.getElementById("infoBubble");
            
            // çŠ¶æ€å˜é‡
            let isTracking = false;
            let lastPosition = null;
            let trackPoints = [];
            
            // æ˜¾ç¤ºä¿¡æ¯æç¤º
            function showInfo(message, isError = false) {
                infoBubble.textContent = message;
                infoBubble.className = isError ? "info-bubble error" : "info-bubble";
                infoBubble.style.display = "block";
                
                setTimeout(() => {
                    infoBubble.style.display = "none";
                }, 4000);
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            function updateStatus(position) {
                if (!position) return;
                
                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);
                const accuracy = position.coords.accuracy;
                const timestamp = new Date(position.timestamp).toLocaleTimeString();
                
                currentPositionEl.textContent = `${lat}, ${lng}`;
                accuracyEl.textContent = `${accuracy.toFixed(0)} ç±³`;
                lastUpdateEl.textContent = timestamp;
                
                // æ ¹æ®ç²¾åº¦è®¾ç½®é¢œè‰²
                let accuracyClass = "accuracy-low";
                if (accuracy < 20) accuracyClass = "accuracy-high";
                else if (accuracy < 50) accuracyClass = "accuracy-medium";
                
                accuracyEl.className = `status-value ${accuracyClass}`;
            }
            
            // åœ¨åœ°å›¾ä¸Šæ›´æ–°ä½ç½®æ ‡è®°
            function updatePositionOnMap(position) {
                // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
                positionLayer.removeAll();
                
                const point = new Point({
                    longitude: position.coords.longitude,
                    latitude: position.coords.latitude
                });
                
                // æ·»åŠ ä½ç½®æ ‡è®°
                const locationGraphic = new Graphic({
                    geometry: point,
                    symbol: locationSymbol
                });
                
                positionLayer.add(locationGraphic);
                
                // æ·»åŠ ç²¾åº¦èŒƒå›´åœ†åœˆï¼ˆå¦‚æœç²¾åº¦å¯ç”¨ï¼‰
                if (position.coords.accuracy) {
                    const accuracyGraphic = new Graphic({
                        geometry: point.buffer(position.coords.accuracy),
                        symbol: accuracySymbol
                    });
                    
                    positionLayer.add(accuracyGraphic);
                }
                
                // è®°å½•è½¨è¿¹ç‚¹
                trackPoints.push(point);
                
                // ç»˜åˆ¶è½¨è¿¹çº¿ï¼ˆå¦‚æœæœ‰è‡³å°‘2ä¸ªç‚¹ï¼‰
                if (trackPoints.length >= 2) {
                    trackLayer.removeAll();
                    
                    const trackLineGraphic = new Graphic({
                        geometry: {
                            type: "polyline",
                            paths: [trackPoints.map(p => [p.longitude, p.latitude])]
                        },
                        symbol: trackLineSymbol
                    });
                    
                    trackLayer.add(trackLineGraphic);
                }
                
                // æ›´æ–°ä¸Šæ¬¡ä½ç½®
                lastPosition = position;
            }
            
            // å¼€å§‹è¿½è¸ª
            function startTracking() {
                if (isTracking) return;
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåœ°ç†å®šä½
                if (!navigator.geolocation) {
                    showInfo("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½", true);
                    return;
                }
                
                isTracking = true;
                trackingStatusEl.textContent = "è¿½è¸ªä¸­";
                trackingStatusEl.style.color = "#4CAF50";
                startTrackingBtn.disabled = true;
                stopTrackingBtn.disabled = false;
                startTrackingBtn.classList.remove("tracking-active");
                stopTrackingBtn.classList.add("tracking-active");
                
                // æ¸…ç©ºä¹‹å‰çš„è½¨è¿¹
                trackPoints = [];
                trackLayer.removeAll();
                
                showInfo("å·²å¼€å§‹å®æ—¶ä½ç½®è¿½è¸ª");
                
                // é¦–æ¬¡å®šä½
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        updateStatus(position);
                        updatePositionOnMap(position);
                        
                        // å°†åœ°å›¾è§†å›¾ç§»åŠ¨åˆ°å½“å‰ä½ç½®
                        view.goTo({
                            center: [position.coords.longitude, position.coords.latitude],
                            zoom: 16
                        });
                    },
                    (error) => {
                        handleGeolocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
                
                // è®¾ç½®æŒç»­ç›‘è§†ä½ç½®å˜åŒ–
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        updateStatus(position);
                        updatePositionOnMap(position);
                    },
                    (error) => {
                        handleGeolocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
            
            // åœæ­¢è¿½è¸ª
            function stopTracking() {
                if (!isTracking) return;
                
                isTracking = false;
                
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                
                trackingStatusEl.textContent = "å·²åœæ­¢";
                trackingStatusEl.style.color = "#F44336";
                startTrackingBtn.disabled = false;
                stopTrackingBtn.disabled = true;
                startTrackingBtn.classList.remove("tracking-active");
                stopTrackingBtn.classList.remove("tracking-active");
                
                showInfo("å·²åœæ­¢ä½ç½®è¿½è¸ª");
            }
            
            // å¤„ç†åœ°ç†å®šä½é”™è¯¯
            function handleGeolocationError(error) {
                let errorMessage = "";
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "ç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™è®¿é—®ä½ç½®ä¿¡æ¯ã€‚";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "æ— æ³•è·å–å½“å‰ä½ç½®ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼ŒGPSä¿¡å·å¼±ï¼‰ã€‚";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "å®šä½è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚";
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMessage = "å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯ã€‚";
                        break;
                }
                
                showInfo("å®šä½å¤±è´¥: " + errorMessage, true);
                stopTracking();
            }
            
            // åˆå§‹åŒ–è¿½è¸ªç»„ä»¶çš„äº‹ä»¶ç›‘å¬
            track.on("track", (event) => {
                if (event.state === "started") {
                    startTracking();
                } else if (event.state === "stopped") {
                    stopTracking();
                }
            });
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬
            startTrackingBtn.addEventListener("click", startTracking);
            stopTrackingBtn.addEventListener("click", stopTracking);
            
            // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ˜¾ç¤ºä½¿ç”¨æç¤º
            view.when(() => {
                setTimeout(() => {
                    showInfo("ç‚¹å‡»å·¦ä¸Šè§’å®šä½æŒ‰é’®æˆ–ä¸‹æ–¹'å¼€å§‹è¿½è¸ª'æŒ‰é’®å¯åŠ¨å®æ—¶ä½ç½®è¿½è¸ª");
                }, 1500);
            });
            
            // é¡µé¢å¸è½½å‰åœæ­¢è¿½è¸ª
            window.addEventListener("beforeunload", stopTracking);
            
            // åˆå§‹çŠ¶æ€
            let watchId = null;
        });
    </script>
</body>
</html>